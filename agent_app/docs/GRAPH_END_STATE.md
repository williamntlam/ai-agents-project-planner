# LangGraph End State Conditions

## Overview

This document explains what state conditions must be met for your LangGraph workflow to successfully reach the `END` node.

## Workflow Path to END

```
draft_hld → draft_lld → design_database → review_doc → [should_revise?] 
                                                              ↓
                                                      ┌───────┴────────┐
                                                      │                │
                                                   revise          continue
                                                      │                │
                                                      ↓                ↓
                                              ┌───────┴───────┐   format_doc → human_review → [approved?] → END
                                              │               │                                    ↓
                                              │               │                                 revise
                                              │               │                                    ↓
                                              ↓               ↓                                    ↓
                                    (LOOPS BACK TO        (LOOPS BACK TO                    (LOOPS BACK TO
                                     draft_hld)            draft_hld)                        draft_hld)
                                     
                                     ⚠️ FULL REVISION CYCLE:
                                     - SystemArchitectAgent runs again
                                     - APIDataAgent runs again  
                                     - DatabaseDesignerAgent runs again
                                     - ReviewerAgent runs again
```

**Important**: When `should_revise()` returns `"revise"`, the workflow loops back to **`draft_hld`** (the very beginning), not just to `review_doc`. This means all agents run again in sequence:
1. SystemArchitectAgent (regenerates HLD)
2. APIDataAgent (regenerates LLD)
3. DatabaseDesignerAgent (regenerates database schema)
4. ReviewerAgent (reviews again)

The same applies if `human_review` returns `"revise"` - it also loops back to `draft_hld`.

## Required State to Reach END

### 1. **After `format_doc` Node Completes**

The `WriterFormatterAgent` must successfully complete, which sets:
- ✅ `final_document`: Must be populated with formatted SDD content
- ✅ `document_status`: Set to `DocumentStatus.REVIEW`

**Code Reference** (`graph.py:87-90`):
```python
elif agent_name == "WriterFormatterAgent":
    document_state.final_document = output.content
    document_status = DocumentStatus.REVIEW
```

### 2. **Revision Check Must Pass**

Before reaching `format_doc`, the `should_revise()` function must return `"continue"`:

**Conditions for `"continue"`** (`graph_edges.py:8-25`):
- ✅ `needs_revision == False` **OR**
- ✅ `revision_count >= max_revisions` (forces continuation even if needs_revision=True)

**Code Reference**:
```python
def should_revise(graph_state: GraphState) -> str:
    state = graph_state['state']
    
    if state.needs_revision:
        if state.revision_count >= state.max_revisions:
            return "continue"  # Force continue
        return "revise"  # Loop back to draft_hld (FULL CYCLE)
    
    return "continue"  # Proceed to format_doc
```

**⚠️ Important**: When `should_revise()` returns `"revise"`, the workflow loops back to **`draft_hld`** (the beginning), causing a full revision cycle where all agents run again:
- SystemArchitectAgent → APIDataAgent → DatabaseDesignerAgent → ReviewerAgent

This is intentional - if the review finds issues, the entire document needs to be regenerated with the feedback incorporated.

### 3. **Human Review Must Approve**

After `format_doc`, the workflow goes to `human_review` node, which calls `_check_approval()`:

**Current Implementation** (`graph.py:11-26`):
```python
def _check_approval(graph_state: GraphState) -> str:
    # For now, always approve (HITL not fully implemented)
    return "approved"
```

**Note**: Currently always returns `"approved"`, so this is not a blocker. In the future, this will check `document_state.approved` or similar field.

### 4. **Complete State Requirements**

For the workflow to successfully reach END, the `DocumentState` should have:

#### Required Fields (Must Exist):
- ✅ `project_brief`: Original input (always required)
- ✅ `hld_draft`: Generated by SystemArchitectAgent
- ✅ `lld_draft`: Generated by APIDataAgent
- ✅ `database_schema`: Generated by DatabaseDesignerAgent
- ✅ `final_document`: Generated by WriterFormatterAgent
- ✅ `document_status`: Set to `DocumentStatus.REVIEW`

#### Revision Control:
- ✅ `needs_revision`: Must be `False` (or `revision_count >= max_revisions`)
- ✅ `revision_count`: Number of revision cycles (0-3 typically)
- ✅ `max_revisions`: Maximum allowed (default: 3)

#### Optional but Recommended:
- `review_feedback`: ReviewFeedback from ReviewerAgent
- `retrieved_context`: RAG context sources used
- `processing_metadata`: Timestamps, agent versions, etc.

## State Validation Methods

The `DocumentState` class provides helper methods to check if state is valid:

### `can_finalize()` Method
```python
def can_finalize(self) -> bool:
    """Check if document can be marked as FINAL."""
    return (
        self.final_document is not None and
        self.document_status == DocumentStatus.REVIEW and
        not self.needs_revision
    )
```

### `should_continue_revision()` Method
```python
def should_continue_revision(self) -> bool:
    """Determine if revision loop should continue."""
    return self.needs_revision and self.revision_count < self.max_revisions
```

## Common Failure Scenarios

### ❌ **Infinite Loop Prevention**

If `needs_revision == True` but `revision_count >= max_revisions`:
- Workflow **forces continuation** to `format_doc`
- Prevents infinite revision loops
- Document may be finalized even if quality is below threshold

**Code** (`graph_edges.py:20-22`):
```python
if state.revision_count >= state.max_revisions:
    return "continue"  # Force continue even if needs revision
```

### ❌ **Missing Required Content**

If any required draft is missing:
- `hld_draft` missing → `APIDataAgent` will fail validation
- `lld_draft` missing → `DatabaseDesignerAgent` will fail validation
- `database_schema` missing → `WriterFormatterAgent` will fail validation

**Validation** (each agent's `validate_state()` method):
```python
# Example from APIDataAgent
if not state.hld_draft or len(state.hld_draft.strip()) < 100:
    errors.append("hld_draft is required and must be at least 100 characters")
```

### ❌ **Reviewer Sets needs_revision=True**

If `ReviewerAgent` sets `needs_revision=True`:
- Workflow loops back to **`draft_hld`** (the beginning, not just review_doc)
- `revision_count` is incremented
- **All agents run again** in sequence:
  1. SystemArchitectAgent (with `revision_feedback` context)
  2. APIDataAgent (with updated HLD)
  3. DatabaseDesignerAgent (with updated HLD + LLD)
  4. ReviewerAgent (reviews again)
- Agents receive `revision_feedback` to improve their output

**Code** (`graph.py:67-85`):
```python
elif agent_name == "ReviewerAgent":
    review_data = json.loads(output.content)
    document_state.review_feedback = review_data
    needs_revision = review_data.get('needs_revision', False)
    document_state.needs_revision = needs_revision
    
    if needs_revision:
        document_state.revision_count += 1  # Increment before loop
```

**Graph Edge** (`graph.py:142-149`):
```python
workflow.add_conditional_edges(
    "review_doc",
    should_revise,
    {
        "revise": "draft_hld",  # ← Loops back to BEGINNING
        "continue": "format_doc"
    }
)
```

**Why Full Loop?** When issues are found, the entire document needs regeneration because:
- HLD issues affect LLD design
- LLD issues affect database schema
- All parts are interdependent

## Summary: End State Checklist

For your LangGraph to reach END, ensure:

1. ✅ **All agents completed successfully**:
   - SystemArchitectAgent → `hld_draft` populated
   - APIDataAgent → `lld_draft` populated
   - DatabaseDesignerAgent → `database_schema` populated
   - WriterFormatterAgent → `final_document` populated

2. ✅ **Revision check passes**:
   - `needs_revision == False` **OR** `revision_count >= max_revisions`

3. ✅ **Document status is correct**:
   - `document_status == DocumentStatus.REVIEW`

4. ✅ **Human review approves** (currently always true):
   - `_check_approval()` returns `"approved"`

## Testing End State

You can check if state is ready for END using:

```python
from agent_app.schemas.document_state import DocumentState

def is_ready_for_end(state: DocumentState) -> bool:
    """Check if state is ready to reach END node."""
    return (
        state.final_document is not None and
        state.document_status == DocumentStatus.REVIEW and
        (not state.needs_revision or state.revision_count >= state.max_revisions)
    )

# Usage
if is_ready_for_end(document_state):
    print("State is ready for END node")
else:
    print("State needs more processing")
```

## Future Enhancements

### Human-in-the-Loop (HITL) Implementation

Currently, `_check_approval()` always returns `"approved"`. To implement real HITL:

```python
def _check_approval(graph_state: GraphState) -> str:
    document_state = graph_state['state']
    
    # Check if human has approved
    if document_state.approved:  # New field needed
        return "approved"
    
    # Check if human has requested revision
    if document_state.human_revision_requested:  # New field needed
        return "revise"
    
    # Wait for human input (using LangGraph interrupts)
    # This would pause the workflow and wait for human response
    return "waiting"  # New state needed
```

### Approval Field

Add to `DocumentState`:
```python
approved: Optional[bool] = Field(
    None,
    description="Human approval status (None = pending, True = approved, False = rejected)"
)
```

